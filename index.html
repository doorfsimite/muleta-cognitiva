<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Muleta Cognitiva - Sistema de Aprendizagem</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial, sans-serif;
        background: #f5f5f5;
      }

      .app-container {
        display: flex;
        height: 100vh;
      }

      .sidebar {
        width: 300px;
        background: white;
        border-right: 1px solid #e0e0e0;
        padding: 20px;
        overflow-y: auto;
        box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .nav-tabs {
        display: flex;
        background: white;
        border-bottom: 1px solid #e0e0e0;
        padding: 0 20px;
      }

      .nav-tab {
        padding: 15px 20px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        font-weight: 500;
        color: #666;
        transition: all 0.2s;
      }

      .nav-tab.active {
        color: #0066cc;
        border-bottom-color: #0066cc;
      }

      .nav-tab:hover {
        background: #f8f9fa;
      }

      .tab-content {
        flex: 1;
        padding: 20px;
        overflow: hidden;
      }

      .tab-pane {
        display: none;
        height: 100%;
      }

      .tab-pane.active {
        display: block;
      }

      #chart {
        width: 100%;
        height: 100%;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .learning-dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto 1fr;
        gap: 20px;
        height: 100%;
      }

      .stats-grid {
        grid-column: 1 / -1;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .stat-number {
        font-size: 32px;
        font-weight: bold;
        color: #0066cc;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #666;
        font-size: 14px;
      }

      .chart-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 15px;
      }

      .chart-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
      }

      .controls {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .controls h3 {
        margin: 0 0 15px 0;
        color: #333;
        font-size: 16px;
      }

      .controls label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #555;
        font-size: 14px;
      }

      .controls select,
      .controls input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        background: white;
        margin-bottom: 15px;
      }

      .controls button {
        width: 100%;
        padding: 10px;
        background: #0066cc;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        margin-bottom: 10px;
        transition: background 0.2s;
      }

      .controls button:hover {
        background: #0052a3;
      }

      .controls button.secondary {
        background: #6c757d;
      }

      .controls button.secondary:hover {
        background: #545b62;
      }

      .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-indicator.connected {
        background: #28a745;
      }

      .status-indicator.disconnected {
        background: #dc3545;
      }

      .entity-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
      }

      .entity-item {
        padding: 10px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background 0.2s;
      }

      .entity-item:hover {
        background: #f8f9fa;
      }

      .entity-item:last-child {
        border-bottom: none;
      }

      .entity-name {
        font-weight: 500;
        color: #333;
      }

      .entity-type {
        font-size: 12px;
        color: #666;
        margin-top: 2px;
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: #666;
        font-size: 14px;
      }

      .error {
        color: #dc3545;
        background: #f8d7da;
        padding: 10px;
        border-radius: 6px;
        margin: 10px 0;
      }

      @media (max-width: 768px) {
        .app-container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          height: auto;
          max-height: 200px;
        }

        .learning-dashboard {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
    <!-- ECharts (Apache) via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  </head>
  <body>
    <div class="app-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <h2 style="margin-top: 0; color: #333">
          <span class="status-indicator" id="apiStatus"></span>
          Muleta Cognitiva
        </h2>

        <div class="controls" aria-labelledby="processar-texto-heading">
          <h3 id="processar-texto-heading">Processar Texto</h3>

          <label for="contentSource">Fonte (opcional):</label>
          <input
            id="contentSource"
            type="text"
            placeholder="browser:manual"
            aria-label="Fonte do conteúdo"
          />

          <label for="contentText">Texto:</label>
          <textarea
            id="contentText"
            rows="6"
            placeholder="Cole aqui o texto para processamento"
            aria-required="true"
            aria-label="Texto para processamento"
          ></textarea>

          <div style="display: flex; gap: 8px; align-items: center">
            <button
              id="processBtn"
              onclick="processContent()"
              aria-label="Processar Texto"
            >
              Processar Texto
            </button>
            <button
              class="secondary"
              id="cancelProcessBtn"
              onclick="cancelProcess()"
              disabled
              aria-label="Cancelar processamento"
            >
              Cancelar
            </button>
          </div>
          <div
            id="processResult"
            style="margin-top: 8px; color: #555"
            role="status"
            aria-live="polite"
          ></div>
        </div>

        <div class="controls">
          <h3>Visualização</h3>

          <label for="graphType">Tipo de Grafo:</label>
          <select id="graphType" onchange="changeGraphType()">
            <option value="force">Grafo de Força</option>
            <option value="circular">Grafo Circular</option>
            <option value="sankey">Sankey Flow</option>
            <option value="flowchart">Fluxograma Argumentativo</option>
          </select>

          <label for="categoryFilter">Filtrar por Categoria:</label>
          <select id="categoryFilter" onchange="applyFilters()">
            <option value="">Todas as categorias</option>
          </select>

          <button onclick="refreshData()">Atualizar Dados</button>
          <button class="secondary" onclick="exportView()">
            Exportar Visualização
          </button>
        </div>

        <div class="controls">
          <h3>Sistema de Cards</h3>
          <div id="cardStats" class="loading">Carregando...</div>
          <button onclick="generateCards()">Gerar Novos Cards</button>
          <button class="secondary" onclick="showDueCards()">
            Cards Pendentes
          </button>
          <button class="secondary" onclick="exportAnki()">
            Exportar para Anki
          </button>
        </div>

        <div class="controls">
          <h3>Entidades</h3>
          <input
            type="text"
            id="entitySearch"
            placeholder="Buscar entidade..."
            onkeyup="filterEntities()"
          />
          <div id="entityList" class="entity-list loading">
            Carregando entidades...
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
          <div class="nav-tab active" onclick="showTab('knowledge-graph')">
            Grafo de Conhecimento
          </div>
          <div class="nav-tab" onclick="showTab('learning-dashboard')">
            Dashboard de Aprendizagem
          </div>
          <div class="nav-tab" onclick="showTab('argument-flows')">
            Fluxogramas Argumentativos
          </div>
          <div class="nav-tab" onclick="showTab('assessments')">Avaliações</div>
          <div class="nav-tab" onclick="showTab('json-insert')">
            Inserir JSON
          </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
          <!-- Knowledge Graph Tab -->
          <div id="knowledge-graph" class="tab-pane active">
            <div id="chart"></div>
          </div>

          <!-- Learning Dashboard Tab -->
          <div id="learning-dashboard" class="tab-pane">
            <div class="learning-dashboard">
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-number" id="totalEntities">-</div>
                  <div class="stat-label">Entidades</div>
                </div>
                <div class="stat-card">
                  <div class="stat-number" id="totalCards">-</div>
                  <div class="stat-label">Cards Criados</div>
                </div>
                <div class="stat-card">
                  <div class="stat-number" id="dueCards">-</div>
                  <div class="stat-label">Cards Pendentes</div>
                </div>
                <div class="stat-card">
                  <div class="stat-number" id="successRate">-</div>
                  <div class="stat-label">Taxa de Sucesso</div>
                </div>
              </div>

              <div class="chart-container">
                <div class="chart-title">Progresso de Revisão</div>
                <div id="reviewChart" style="height: 300px"></div>
              </div>

              <div class="chart-container">
                <div class="chart-title">Distribuição de Cards por Tipo</div>
                <div id="cardTypeChart" style="height: 300px"></div>
              </div>
            </div>
          </div>

          <!-- Argument Flows Tab -->
          <div id="argument-flows" class="tab-pane">
            <div style="display: flex; gap: 20px; height: 100%">
              <div style="flex: 1">
                <div class="chart-title">Sequências Argumentativas</div>
                <div
                  id="argumentChart"
                  style="
                    height: calc(100% - 30px);
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                  "
                ></div>
              </div>
              <div style="width: 250px">
                <div class="controls" style="margin: 0">
                  <h3>Criar Sequência</h3>
                  <label for="sequenceTitle">Título:</label>
                  <input
                    type="text"
                    id="sequenceTitle"
                    placeholder="Nome da sequência"
                  />

                  <label>Entidades Relacionadas:</label>
                  <div
                    id="selectedEntities"
                    style="
                      max-height: 150px;
                      overflow-y: auto;
                      border: 1px solid #e0e0e0;
                      border-radius: 6px;
                      padding: 10px;
                      margin-bottom: 15px;
                    "
                  >
                    <em style="color: #666">Selecione entidades do grafo</em>
                  </div>

                  <button onclick="createArgumentSequence()">
                    Criar Sequência
                  </button>
                  <button class="secondary" onclick="loadArgumentSequences()">
                    Listar Sequências
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Assessments Tab -->
          <div id="assessments" class="tab-pane">
            <div
              style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                height: 100%;
              "
            >
              <div class="chart-container">
                <div class="chart-title">Histórico de Avaliações</div>
                <div
                  id="assessmentChart"
                  style="height: calc(100% - 50px)"
                ></div>
              </div>

              <div class="chart-container">
                <div class="chart-title">Análise de Gaps de Conhecimento</div>
                <div
                  id="knowledgeGapChart"
                  style="height: calc(100% - 50px)"
                ></div>
              </div>
            </div>
          </div>

          <!-- JSON Insert Tab -->
          <div id="json-insert" class="tab-pane">
            <div style="display: flex; gap: 20px; height: 100%">
              <div style="flex: 1">
                <div class="chart-container" style="height: 100%">
                  <div class="chart-title">Inserir Dados JSON</div>
                  <div
                    style="
                      height: calc(100% - 60px);
                      display: flex;
                      flex-direction: column;
                      gap: 15px;
                    "
                  >
                    <!-- Instructions -->
                    <div
                      style="
                        background: #f8f9fa;
                        padding: 15px;
                        border-radius: 8px;
                        border-left: 4px solid #007bff;
                      "
                    >
                      <h4 style="margin: 0 0 10px 0; color: #333">
                        Como usar:
                      </h4>
                      <ol style="margin: 0; padding-left: 20px; color: #666">
                        <li>
                          Use o GitHub Copilot para gerar JSON no formato
                          correto
                        </li>
                        <li>Cole o JSON completo no campo abaixo</li>
                        <li>
                          Clique em "Inserir Dados" para adicionar ao sistema
                        </li>
                        <li>Os dados serão validados antes da inserção</li>
                      </ol>
                    </div>

                    <!-- Source Info -->
                    <div style="display: flex; gap: 10px">
                      <div style="flex: 1">
                        <label for="jsonSourceType">Tipo de Fonte:</label>
                        <select
                          id="jsonSourceType"
                          style="
                            width: 100%;
                            padding: 8px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                          "
                        >
                          <option value="manual">Manual</option>
                          <option value="copilot">GitHub Copilot</option>
                          <option value="text">Texto Processado</option>
                          <option value="pdf">PDF Processado</option>
                          <option value="video">Vídeo Processado</option>
                        </select>
                      </div>
                      <div style="flex: 1">
                        <label for="jsonSourcePath">Caminho/Descrição:</label>
                        <input
                          id="jsonSourcePath"
                          type="text"
                          placeholder="manual:json_insert"
                          style="
                            width: 100%;
                            padding: 8px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                          "
                        />
                      </div>
                    </div>

                    <!-- JSON Input Area -->
                    <div style="flex: 1; display: flex; flex-direction: column">
                      <label for="jsonData">Dados JSON:</label>
                      <textarea
                        id="jsonData"
                        placeholder='Cole aqui o JSON no formato:
{
  "entities": [
    {
      "name": "Nome da Entidade",
      "type": "conceito",
      "description": "Descrição breve"
    }
  ],
  "relations": [
    {
      "from": "Entidade1",
      "to": "Entidade2", 
      "type": "relacionado_a",
      "evidence": "Evidência da relação"
    }
  ]
}'
                        style="
                          flex: 1;
                          padding: 12px;
                          border: 1px solid #ddd;
                          border-radius: 4px;
                          font-family: 'Monaco', 'Menlo', 'Ubuntu Mono',
                            monospace;
                          font-size: 13px;
                          resize: none;
                        "
                      ></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px; align-items: center">
                      <button
                        id="insertJsonBtn"
                        onclick="insertJsonData()"
                        style="
                          background: #28a745;
                          color: white;
                          border: none;
                          padding: 10px 20px;
                          border-radius: 4px;
                          cursor: pointer;
                        "
                      >
                        Inserir Dados
                      </button>
                      <button
                        id="validateJsonBtn"
                        onclick="validateJsonData()"
                        style="
                          background: #17a2b8;
                          color: white;
                          border: none;
                          padding: 10px 20px;
                          border-radius: 4px;
                          cursor: pointer;
                        "
                      >
                        Validar JSON
                      </button>
                      <button
                        onclick="clearJsonData()"
                        style="
                          background: #6c757d;
                          color: white;
                          border: none;
                          padding: 10px 20px;
                          border-radius: 4px;
                          cursor: pointer;
                        "
                      >
                        Limpar
                      </button>
                      <button
                        id="cancelJsonBtn"
                        onclick="cancelJsonInsert()"
                        disabled
                        style="
                          background: #dc3545;
                          color: white;
                          border: none;
                          padding: 10px 20px;
                          border-radius: 4px;
                          cursor: pointer;
                          opacity: 0.6;
                        "
                      >
                        Cancelar
                      </button>
                    </div>

                    <!-- Result Display -->
                    <div
                      id="jsonResult"
                      style="
                        padding: 10px;
                        border-radius: 4px;
                        min-height: 40px;
                        border: 1px solid #e9ecef;
                        background: #f8f9fa;
                      "
                      role="status"
                      aria-live="polite"
                    >
                      Aguardando dados JSON...
                    </div>
                  </div>
                </div>
              </div>

              <!-- JSON Format Guide -->
              <div style="width: 300px">
                <div class="chart-container" style="height: 100%">
                  <div class="chart-title">Formato JSON</div>
                  <div
                    style="
                      height: calc(100% - 40px);
                      overflow-y: auto;
                      padding: 15px;
                      font-size: 12px;
                    "
                  >
                    <h4>Tipos de Entidades:</h4>
                    <ul style="margin: 5px 0 15px 20px; color: #666">
                      <li>pessoa</li>
                      <li>lugar</li>
                      <li>organizacao</li>
                      <li>conceito</li>
                      <li>ideia</li>
                      <li>teoria</li>
                      <li>evento</li>
                      <li>obra</li>
                      <li>tecnologia</li>
                      <li>metodo</li>
                      <li>metrica</li>
                      <li>problema</li>
                      <li>solucao</li>
                      <li>premissa</li>
                      <li>conclusao</li>
                      <li>tema</li>
                      <li>assunto</li>
                      <li>outro</li>
                    </ul>

                    <h4>Tipos de Relações:</h4>
                    <ul style="margin: 5px 0 15px 20px; color: #666">
                      <li>tipo_de</li>
                      <li>parte_de</li>
                      <li>exemplo_de</li>
                      <li>causa_de</li>
                      <li>efeito_de</li>
                      <li>apoia</li>
                      <li>contradiz</li>
                      <li>requer</li>
                      <li>usa</li>
                      <li>depende_de</li>
                      <li>autor_de</li>
                      <li>publicado_em</li>
                      <li>ocorre_em</li>
                      <li>compara_com</li>
                      <li>resolve</li>
                      <li>conduz_a</li>
                      <li>precede</li>
                      <li>sucede</li>
                      <li>relacionado_a</li>
                    </ul>

                    <h4>Exemplo Completo:</h4>
                    <pre
                      style="
                        background: #f1f3f4;
                        padding: 10px;
                        border-radius: 4px;
                        font-size: 11px;
                        overflow-x: auto;
                      "
                    >
{
  "entities": [
    {
      "name": "Filosofia",
      "type": "conceito",
      "description": "Estudo das questões fundamentais sobre existência, conhecimento e valores"
    },
    {
      "name": "Epistemologia", 
      "type": "conceito",
      "description": "Ramo da filosofia que estuda o conhecimento"
    }
  ],
  "relations": [
    {
      "from": "Epistemologia",
      "to": "Filosofia",
      "type": "parte_de",
      "evidence": "Epistemologia é um ramo da filosofia"
    }
  ]
}</pre
                    >

                    <div
                      style="
                        background: #fff3cd;
                        padding: 10px;
                        border-radius: 4px;
                        margin-top: 15px;
                        border-left: 4px solid #ffc107;
                      "
                    >
                      <strong>Dica:</strong> Use o GitHub Copilot para gerar o
                      JSON. Forneça o contexto do texto e peça para extrair
                      entidades e relações no formato acima.
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Global state management
      const state = {
        apiBaseUrl: 'http://localhost:8000/api',
        currentData: null,
        selectedEntities: new Set(),
        currentTab: 'knowledge-graph',
        charts: {}
      }

      // Initialize charts
      const mainChart = echarts.init(document.getElementById('chart'))
      const reviewChart = echarts.init(document.getElementById('reviewChart'))
      const cardTypeChart = echarts.init(
        document.getElementById('cardTypeChart')
      )
      const argumentChart = echarts.init(
        document.getElementById('argumentChart')
      )
      const assessmentChart = echarts.init(
        document.getElementById('assessmentChart')
      )
      const knowledgeGapChart = echarts.init(
        document.getElementById('knowledgeGapChart')
      )

      state.charts = {
        main: mainChart,
        review: reviewChart,
        cardType: cardTypeChart,
        argument: argumentChart,
        assessment: assessmentChart,
        knowledgeGap: knowledgeGapChart
      }

      // Utility functions
      function escapeHtml(s) {
        return String(s)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;')
      }

      function formatDate(dateString) {
        if (!dateString) return 'N/A'
        return new Date(dateString).toLocaleDateString('pt-BR')
      }

      function setApiStatus(connected) {
        const indicator = document.getElementById('apiStatus')
        indicator.className = `status-indicator ${
          connected ? 'connected' : 'disconnected'
        }`
      }

      function showError(message) {
        console.error('Error:', message)
        // Could implement toast notifications here
      }

      function showLoading(elementId, show = true) {
        const element = document.getElementById(elementId)
        if (show) {
          element.innerHTML = '<div class="loading">Carregando...</div>'
        }
      }

      // API communication
      async function apiCall(endpoint, options = {}) {
        try {
          const response = await fetch(`${state.apiBaseUrl}${endpoint}`, {
            headers: {
              'Content-Type': 'application/json',
              ...options.headers
            },
            ...options
          })

          if (!response.ok) {
            // Surface specific errors
            let msg = `API Error: ${response.status} ${response.statusText}`
            try {
              const body = await response.json()
              if (body && body.error) msg = body.error
            } catch {}
            throw new Error(msg)
          }

          setApiStatus(true)
          return await response.json()
        } catch (error) {
          setApiStatus(false)
          showError(`Erro na API: ${error.message}`)
          throw error
        }
      }

      // Text processing workflow
      let processAbortController = null
      const CLIENT_TIMEOUT_MS = 60000

      async function processContent() {
        const btn = document.getElementById('processBtn')
        const cancelBtn = document.getElementById('cancelProcessBtn')
        const resultBox = document.getElementById('processResult')
        const source =
          document.getElementById('contentSource').value || 'browser:manual'
        const content = (
          document.getElementById('contentText').value || ''
        ).trim()

        // Prevent re-submission while in progress
        if (btn.disabled) return

        // Validation
        if (!content || content.length < 10) {
          resultBox.textContent = 'O texto é obrigatório (mín. 10 caracteres).'
          return
        }
        // if (content.length > 50000) {
        //   resultBox.textContent =
        //     'O texto excede o limite máximo (50.000 caracteres).'
        //   return
        // }

        // Set loading state
        resultBox.textContent = 'Processando...'
        btn.disabled = true
        cancelBtn.disabled = false

        try {
          processAbortController = new AbortController()

          // Implement client-side timeout wrapper
          const fetchPromise = apiCall('/content/process', {
            method: 'POST',
            body: JSON.stringify({
              content,
              source_type: 'text',
              source_path: source
            }),
            signal: processAbortController.signal
          })

          const timeoutPromise = new Promise((_, reject) =>
            setTimeout(
              () => reject(new Error('Tempo de processamento excedido')),
              CLIENT_TIMEOUT_MS
            )
          )

          const res = await Promise.race([fetchPromise, timeoutPromise])

          if (res?.success) {
            const ec = res.entities_created ?? 0
            const rc = res.relations_created ?? 0
            const oc = res.observations_created ?? 0
            const ts = new Date().toLocaleString('pt-BR')
            resultBox.textContent = `Processamento concluído: ${ec} entidades, ${rc} relações, ${oc} observações. (${ts})`
            await refreshData()
          } else {
            resultBox.textContent = `Erro: ${
              res?.error || 'Falha no processamento.'
            }`
          }
        } catch (e) {
          if (e.name === 'AbortError') {
            resultBox.textContent = 'Processamento cancelado.'
          } else if (
            (e.message || '').includes('Tempo de processamento excedido')
          ) {
            resultBox.textContent = 'Tempo de processamento excedido'
          } else if (
            (e.message || '').toLowerCase().includes('failed to fetch')
          ) {
            resultBox.textContent = 'Não foi possível conectar ao servidor'
          } else {
            resultBox.textContent = e.message || 'Erro inesperado'
          }
        } finally {
          btn.disabled = false
          cancelBtn.disabled = true
          processAbortController = null
        }
      }

      function cancelProcess() {
        if (processAbortController) processAbortController.abort()
      }

      // Data loading functions
      async function loadVisualizationData() {
        try {
          const data = await apiCall('/visualization')
          state.currentData = data
          return data
        } catch (error) {
          showError('Erro ao carregar dados de visualização')
          return null
        }
      }

      async function loadStatistics() {
        try {
          const stats = await apiCall('/statistics')
          updateStatistics(stats)
          return stats
        } catch (error) {
          showError('Erro ao carregar estatísticas')
          return null
        }
      }

      async function loadEntities() {
        try {
          const response = await apiCall('/entities')
          updateEntityList(response.entities || [])
          updateCategoryFilter(response.entities || [])
          return response.entities
        } catch (error) {
          showError('Erro ao carregar entidades')
          return []
        }
      }

      // Visualization functions
      function makeForceOption(nodes, links, categories) {
        return {
          backgroundColor: '#fff',
          tooltip: {
            trigger: 'item',
            confine: true,
            formatter: function (params) {
              if (params.dataType === 'node') {
                const d = params.data || {}
                const header =
                  `<b>${escapeHtml(d.name)}</b>` +
                  (d.entityType
                    ? ` <span style="color:#999">(${escapeHtml(
                        d.entityType
                      )})</span>`
                    : '')

                if (Array.isArray(d.observations) && d.observations.length) {
                  return (
                    header +
                    '<br/>' +
                    d.observations
                      .map((o) => `• ${escapeHtml(o)}`)
                      .join('<br/>')
                  )
                }
                return header
              } else if (params.dataType === 'edge') {
                const e = params.data || {}
                const rel = e.relationType
                  ? `<b>${escapeHtml(e.relationType)}</b>`
                  : ''
                return `${escapeHtml(
                  e.from || params.data.source || ''
                )} — ${rel} → ${escapeHtml(e.to || params.data.target || '')}`
              }
              return params.name || ''
            }
          },
          legend: categories.length
            ? [
                {
                  data: categories.map((c) => c.name),
                  left: 'left',
                  orient: 'vertical',
                  selectedMode: true,
                  textStyle: { fontSize: 12 }
                }
              ]
            : undefined,
          series: [
            {
              type: 'graph',
              layout: 'force',
              data: nodes,
              links: links,
              categories: categories,
              roam: true,
              focusNodeAdjacency: true,
              edgeSymbol: ['none', 'arrow'],
              edgeSymbolSize: 10,
              label: { show: true, position: 'right', formatter: '{b}' },
              edgeLabel: {
                show: true,
                formatter: function (p) {
                  return p.data && p.data.relationType
                    ? p.data.relationType
                    : ''
                },
                fontSize: 11
              },
              lineStyle: { color: 'source', width: 1.2, opacity: 0.9 },
              emphasis: { focus: 'adjacency', lineStyle: { width: 2 } },
              force: { repulsion: 1200, edgeLength: 400, gravity: 0.03 }
            }
          ]
        }
      }

      function makeCircularOption(nodes, links, categories) {
        return {
          backgroundColor: '#fff',
          tooltip: {
            trigger: 'item',
            confine: true,
            formatter: function (params) {
              const d = params.data || {}
              const header =
                `<b>${escapeHtml(d.name)}</b>` +
                (d.entityType
                  ? ` <span style="color:#999">(${escapeHtml(
                      d.entityType
                    )})</span>`
                  : '')

              if (Array.isArray(d.observations) && d.observations.length) {
                return (
                  header +
                  '<br/>' +
                  d.observations.map((o) => `• ${escapeHtml(o)}`).join('<br/>')
                )
              }
              return header
            }
          },
          legend: categories.length
            ? [
                {
                  data: categories.map((c) => c.name),
                  left: 'left',
                  orient: 'vertical',
                  selectedMode: true,
                  textStyle: { fontSize: 12 }
                }
              ]
            : undefined,
          series: [
            {
              type: 'graph',
              layout: 'circular',
              data: nodes,
              links: links,
              categories: categories,
              roam: true,
              focusNodeAdjacency: true,
              edgeSymbol: ['none', 'arrow'],
              edgeSymbolSize: 8,
              label: { show: true, position: 'right', formatter: '{b}' },
              edgeLabel: {
                show: true,
                formatter: function (p) {
                  return p.data && p.data.relationType
                    ? p.data.relationType
                    : ''
                },
                fontSize: 11
              },
              circular: { rotateLabel: true },
              lineStyle: { color: 'source', width: 1.2, opacity: 0.9 },
              emphasis: { focus: 'adjacency', lineStyle: { width: 2 } }
            }
          ]
        }
      }

      function makeFlowchartOption(nodes, links) {
        // Transform data for flowchart visualization
        const flowNodes = nodes.map((node, index) => ({
          id: node.name,
          name: node.name,
          value: [index * 100, Math.random() * 400],
          symbol: 'roundRect',
          symbolSize: [100, 60],
          itemStyle: {
            color:
              node.entityType === 'premise'
                ? '#91cc75'
                : node.entityType === 'conclusion'
                ? '#fac858'
                : node.entityType === 'evidence'
                ? '#73c0de'
                : '#ee6666'
          },
          label: {
            show: true,
            position: 'inside',
            fontSize: 10,
            width: 80,
            overflow: 'truncate'
          }
        }))

        return {
          backgroundColor: '#fff',
          tooltip: {
            trigger: 'item',
            formatter: function (params) {
              return `<b>${escapeHtml(
                params.data.name
              )}</b><br/>Tipo: ${escapeHtml(
                params.data.entityType || 'conceito'
              )}`
            }
          },
          series: [
            {
              type: 'graph',
              layout: 'none',
              data: flowNodes,
              links: links.map((link) => ({
                source: link.source,
                target: link.target,
                lineStyle: { width: 2, curveness: 0.1 }
              })),
              roam: true,
              edgeSymbol: ['none', 'arrow'],
              edgeSymbolSize: 8,
              emphasis: { focus: 'adjacency' }
            }
          ]
        }
      }

      function makeSankeyOption(nodes, links) {
        // Transform data for Sankey diagram
        const sankeyNodes = nodes.map((node) => ({
          name: node.name,
          value: node.value || 1
        }))

        const sankeyLinks = links.map((link) => ({
          source: link.source,
          target: link.target,
          value: 1
        }))

        return {
          backgroundColor: '#fff',
          tooltip: { trigger: 'item' },
          series: [
            {
              type: 'sankey',
              data: sankeyNodes,
              links: sankeyLinks,
              focusNodeAdjacency: 'allEdges',
              itemStyle: { borderWidth: 1, borderColor: '#aaa' },
              lineStyle: { color: 'source', curveness: 0.5 }
            }
          ]
        }
      }

      // Learning analytics functions
      function updateStatistics(stats) {
        document.getElementById('totalEntities').textContent =
          stats.entities_count || 0
        document.getElementById('totalCards').textContent =
          stats.total_cards || 0
        document.getElementById('dueCards').textContent = stats.cards_due || 0
        document.getElementById('successRate').textContent =
          stats.avg_success_rate
            ? `${Math.round(stats.avg_success_rate * 100)}%`
            : '0%'
      }

      function updateCardStats() {
        // This would load card statistics from API
        document.getElementById('cardStats').innerHTML = `
          <div style="font-size: 12px; color: #666;">
            <div>Cards pendentes: <strong>5</strong></div>
            <div>Próxima revisão: <strong>Hoje</strong></div>
            <div>Taxa de acerto: <strong>85%</strong></div>
          </div>
        `
      }

      function updateEntityList(entities) {
        const listElement = document.getElementById('entityList')
        if (!entities.length) {
          listElement.innerHTML =
            '<div style="padding: 10px; color: #666; font-style: italic;">Nenhuma entidade encontrada</div>'
          return
        }

        listElement.innerHTML = entities
          .map(
            (entity) => `
          <div class="entity-item" onclick="selectEntity('${entity.name}')">
            <div class="entity-name">${escapeHtml(entity.name)}</div>
            <div class="entity-type">${escapeHtml(
              entity.entity_type || 'sem categoria'
            )}</div>
          </div>
        `
          )
          .join('')
      }

      function updateCategoryFilter(entities) {
        const filterElement = document.getElementById('categoryFilter')
        const categories = [
          ...new Set(entities.map((e) => e.entity_type).filter(Boolean))
        ]

        filterElement.innerHTML =
          '<option value="">Todas as categorias</option>' +
          categories
            .map(
              (cat) =>
                `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`
            )
            .join('')
      }

      // Interactive functions
      function changeGraphType() {
        if (!state.currentData) return

        const type = document.getElementById('graphType').value
        const { nodes, links, categories } = state.currentData

        let option
        switch (type) {
          case 'force':
            option = makeForceOption(nodes, links, categories)
            break
          case 'circular':
            option = makeCircularOption(nodes, links, categories)
            break
          case 'sankey':
            option = makeSankeyOption(nodes, links)
            break
          case 'flowchart':
            option = makeFlowchartOption(nodes, links)
            break
          default:
            option = makeForceOption(nodes, links, categories)
        }

        state.charts.main.setOption(option, true)
      }

      function showTab(tabName) {
        // Update active tab
        document
          .querySelectorAll('.nav-tab')
          .forEach((tab) => tab.classList.remove('active'))
        document
          .querySelector(`[onclick="showTab('${tabName}')"]`)
          .classList.add('active')

        // Update active pane
        document
          .querySelectorAll('.tab-pane')
          .forEach((pane) => pane.classList.remove('active'))
        document.getElementById(tabName).classList.add('active')

        state.currentTab = tabName

        // Resize charts when tab becomes visible
        setTimeout(() => {
          Object.values(state.charts).forEach((chart) => chart.resize())
        }, 100)

        // Load tab-specific data
        if (tabName === 'learning-dashboard') {
          loadLearningDashboard()
        } else if (tabName === 'argument-flows') {
          loadArgumentFlows()
        } else if (tabName === 'assessments') {
          loadAssessments()
        }
      }

      function selectEntity(entityName) {
        if (state.selectedEntities.has(entityName)) {
          state.selectedEntities.delete(entityName)
        } else {
          state.selectedEntities.add(entityName)
        }
        updateSelectedEntitiesDisplay()
      }

      function updateSelectedEntitiesDisplay() {
        const container = document.getElementById('selectedEntities')
        if (state.selectedEntities.size === 0) {
          container.innerHTML =
            '<em style="color: #666;">Selecione entidades do grafo</em>'
        } else {
          container.innerHTML = Array.from(state.selectedEntities)
            .map(
              (name) =>
                `<div style="background: #e3f2fd; padding: 4px 8px; margin: 2px 0; border-radius: 4px; font-size: 12px;">${escapeHtml(
                  name
                )} <span onclick="selectEntity('${name}')" style="cursor: pointer; color: #1976d2; font-weight: bold;">✕</span></div>`
            )
            .join('')
        }
      }

      function filterEntities() {
        const searchTerm = document
          .getElementById('entitySearch')
          .value.toLowerCase()
        const items = document.querySelectorAll('.entity-item')

        items.forEach((item) => {
          const name = item
            .querySelector('.entity-name')
            .textContent.toLowerCase()
          const type = item
            .querySelector('.entity-type')
            .textContent.toLowerCase()
          const matches = name.includes(searchTerm) || type.includes(searchTerm)
          item.style.display = matches ? 'block' : 'none'
        })
      }

      function applyFilters() {
        const category = document.getElementById('categoryFilter').value
        // Implementation would filter the visualization based on selected category
        console.log('Filtering by category:', category)
      }

      // Learning dashboard functions
      function loadLearningDashboard() {
        // Review progress chart
        const reviewOption = {
          title: { text: '', left: 'center' },
          xAxis: {
            type: 'category',
            data: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb']
          },
          yAxis: { type: 'value' },
          series: [
            {
              data: [12, 8, 15, 9, 11, 7, 6],
              type: 'line',
              smooth: true,
              areaStyle: { opacity: 0.3 }
            }
          ]
        }
        state.charts.review.setOption(reviewOption)

        // Card type distribution
        const cardTypeOption = {
          title: { text: '', left: 'center' },
          tooltip: { trigger: 'item' },
          series: [
            {
              type: 'pie',
              radius: '70%',
              data: [
                { value: 35, name: 'Definição' },
                { value: 25, name: 'Socrático' },
                { value: 20, name: 'Relação' },
                { value: 20, name: 'Aplicação' }
              ],
              emphasis: {
                itemStyle: {
                  shadowBlur: 10,
                  shadowOffsetX: 0,
                  shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
              }
            }
          ]
        }
        state.charts.cardType.setOption(cardTypeOption)
      }

      function loadArgumentFlows() {
        // Mock argument sequence visualization
        const argumentOption = {
          backgroundColor: '#fff',
          tooltip: { trigger: 'item' },
          series: [
            {
              type: 'graph',
              layout: 'none',
              data: [
                { name: 'Premissa 1', x: 100, y: 100, symbolSize: 80 },
                { name: 'Premissa 2', x: 100, y: 200, symbolSize: 80 },
                { name: 'Inferência', x: 300, y: 150, symbolSize: 80 },
                { name: 'Conclusão', x: 500, y: 150, symbolSize: 80 }
              ],
              links: [
                { source: 'Premissa 1', target: 'Inferência' },
                { source: 'Premissa 2', target: 'Inferência' },
                { source: 'Inferência', target: 'Conclusão' }
              ],
              roam: true,
              edgeSymbol: ['none', 'arrow'],
              edgeSymbolSize: 8,
              itemStyle: { color: '#91cc75' },
              lineStyle: { width: 2 }
            }
          ]
        }
        state.charts.argument.setOption(argumentOption)
      }

      function loadAssessments() {
        // Assessment history chart
        const assessmentOption = {
          title: { text: '', left: 'center' },
          xAxis: {
            type: 'category',
            data: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai']
          },
          yAxis: { type: 'value', max: 100 },
          series: [
            {
              data: [75, 82, 78, 85, 88],
              type: 'bar',
              itemStyle: { color: '#0066cc' }
            }
          ]
        }
        state.charts.assessment.setOption(assessmentOption)

        // Knowledge gaps chart
        const gapOption = {
          title: { text: '', left: 'center' },
          radar: {
            indicator: [
              { name: 'Filosofia Política', max: 100 },
              { name: 'Epistemologia', max: 100 },
              { name: 'Ética', max: 100 },
              { name: 'Metafísica', max: 100 },
              { name: 'Lógica', max: 100 }
            ]
          },
          series: [
            {
              type: 'radar',
              data: [
                {
                  value: [65, 85, 70, 55, 90],
                  name: 'Conhecimento Atual'
                }
              ]
            }
          ]
        }
        state.charts.knowledgeGap.setOption(gapOption)
      }

      // Action functions
      async function refreshData() {
        try {
          await Promise.all([
            loadVisualizationData(),
            loadStatistics(),
            loadEntities()
          ])

          if (state.currentData) {
            changeGraphType() // Refresh current visualization
          }

          updateCardStats()
        } catch (error) {
          showError('Erro ao atualizar dados')
        }
      }

      function generateCards() {
        if (state.selectedEntities.size === 0) {
          alert('Selecione pelo menos uma entidade para gerar cards')
          return
        }

        console.log(
          'Generating cards for entities:',
          Array.from(state.selectedEntities)
        )
        // Implementation would call API to generate cards
      }

      function showDueCards() {
        console.log('Showing due cards')
        // Implementation would show due cards modal/page
      }

      function exportAnki() {
        console.log('Exporting to Anki')
        // Implementation would export cards to Anki format
      }

      function exportView() {
        const chart = state.charts.main
        const url = chart.getDataURL({
          type: 'png',
          backgroundColor: '#fff'
        })

        const link = document.createElement('a')
        link.download = 'muleta-cognitiva-graph.png'
        link.href = url
        link.click()
      }

      function createArgumentSequence() {
        const title = document.getElementById('sequenceTitle').value
        if (!title || state.selectedEntities.size === 0) {
          alert('Informe um título e selecione entidades')
          return
        }

        console.log(
          'Creating argument sequence:',
          title,
          Array.from(state.selectedEntities)
        )
        // Implementation would call API to create sequence
      }

      function loadArgumentSequences() {
        console.log('Loading argument sequences')
        // Implementation would load existing sequences
      }

      // Initialization
      async function init() {
        try {
          // Load initial data
          await refreshData()

          // Set up resize handlers
          window.addEventListener('resize', () => {
            Object.values(state.charts).forEach((chart) => chart.resize())
          })

          // Initialize with force layout
          if (state.currentData) {
            const { nodes, links, categories } = state.currentData
            state.charts.main.setOption(
              makeForceOption(nodes, links, categories)
            )
          }

          console.log('Application initialized successfully')
        } catch (error) {
          showError('Erro na inicialização da aplicação')
          console.error('Initialization error:', error)
        }
      }

      // Start the application
      init()

      // JSON Insert functionality
      let jsonInsertAbortController = null

      async function insertJsonData() {
        const btn = document.getElementById('insertJsonBtn')
        const cancelBtn = document.getElementById('cancelJsonBtn')
        const resultBox = document.getElementById('jsonResult')
        const jsonData = document.getElementById('jsonData').value.trim()
        const sourceType = document.getElementById('jsonSourceType').value
        const sourcePath =
          document.getElementById('jsonSourcePath').value.trim() ||
          'manual:json_insert'

        // Prevent re-submission while in progress
        if (btn.disabled) return

        // Validation
        if (!jsonData) {
          resultBox.textContent = 'JSON é obrigatório.'
          resultBox.style.background = '#f8d7da'
          resultBox.style.color = '#721c24'
          return
        }

        // Try to parse JSON first
        let parsedData
        try {
          parsedData = JSON.parse(jsonData)
        } catch (e) {
          resultBox.textContent = `JSON inválido: ${e.message}`
          resultBox.style.background = '#f8d7da'
          resultBox.style.color = '#721c24'
          return
        }

        // Set loading state
        resultBox.textContent = 'Inserindo dados...'
        resultBox.style.background = '#d1ecf1'
        resultBox.style.color = '#0c5460'
        btn.disabled = true
        cancelBtn.disabled = false

        try {
          jsonInsertAbortController = new AbortController()

          const payload = {
            ...parsedData,
            source_type: sourceType,
            source_path: sourcePath
          }

          const result = await apiCall('/data/insert', {
            method: 'POST',
            body: JSON.stringify(payload),
            signal: jsonInsertAbortController.signal
          })

          if (result.success) {
            resultBox.textContent = `Sucesso! ${result.entities_created} entidades e ${result.relations_created} relações criadas.`
            resultBox.style.background = '#d4edda'
            resultBox.style.color = '#155724'

            // Clear the form
            document.getElementById('jsonData').value = ''

            // Refresh the visualization
            await refreshData()
          } else {
            resultBox.textContent = `Erro: ${
              result.error || 'Falha na inserção'
            }`
            resultBox.style.background = '#f8d7da'
            resultBox.style.color = '#721c24'
          }
        } catch (e) {
          if (e.name === 'AbortError') {
            resultBox.textContent = 'Inserção cancelada pelo usuário'
            resultBox.style.background = '#fff3cd'
            resultBox.style.color = '#856404'
          } else {
            resultBox.textContent = `Erro: ${e.message || 'Erro inesperado'}`
            resultBox.style.background = '#f8d7da'
            resultBox.style.color = '#721c24'
          }
        } finally {
          btn.disabled = false
          cancelBtn.disabled = true
          jsonInsertAbortController = null
        }
      }

      function validateJsonData() {
        const resultBox = document.getElementById('jsonResult')
        const jsonData = document.getElementById('jsonData').value.trim()

        if (!jsonData) {
          resultBox.textContent = 'Nenhum JSON para validar.'
          resultBox.style.background = '#fff3cd'
          resultBox.style.color = '#856404'
          return
        }

        try {
          const parsed = JSON.parse(jsonData)

          // Validate structure
          if (!parsed.entities || !Array.isArray(parsed.entities)) {
            throw new Error(
              'Campo "entities" é obrigatório e deve ser um array'
            )
          }

          if (!parsed.relations || !Array.isArray(parsed.relations)) {
            throw new Error(
              'Campo "relations" é obrigatório e deve ser um array'
            )
          }

          // Validate entities
          for (let i = 0; i < parsed.entities.length; i++) {
            const entity = parsed.entities[i]
            if (!entity.name || !entity.type || !entity.description) {
              throw new Error(
                `Entidade ${i}: campos "name", "type" e "description" são obrigatórios`
              )
            }
          }

          // Validate relations
          for (let i = 0; i < parsed.relations.length; i++) {
            const relation = parsed.relations[i]
            if (
              !relation.from ||
              !relation.to ||
              !relation.type ||
              !relation.evidence
            ) {
              throw new Error(
                `Relação ${i}: campos "from", "to", "type" e "evidence" são obrigatórios`
              )
            }
          }

          resultBox.textContent = `JSON válido! ${parsed.entities.length} entidades e ${parsed.relations.length} relações encontradas.`
          resultBox.style.background = '#d4edda'
          resultBox.style.color = '#155724'
        } catch (e) {
          resultBox.textContent = `JSON inválido: ${e.message}`
          resultBox.style.background = '#f8d7da'
          resultBox.style.color = '#721c24'
        }
      }

      function clearJsonData() {
        document.getElementById('jsonData').value = ''
        document.getElementById('jsonSourcePath').value = 'manual:json_insert'
        document.getElementById('jsonSourceType').value = 'manual'

        const resultBox = document.getElementById('jsonResult')
        resultBox.textContent = 'Aguardando dados JSON...'
        resultBox.style.background = '#f8f9fa'
        resultBox.style.color = '#333'
      }

      function cancelJsonInsert() {
        if (jsonInsertAbortController) {
          jsonInsertAbortController.abort()
        }
      }
    </script>
  </body>
</html>
